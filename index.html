<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ISS Orbital Tracker</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Space Mono', monospace, sans-serif;
            color: #fff;
        }

        /* Glassmorphic Dashboard Panel */
        #dashboard {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 320px;
            background: rgba(10, 15, 25, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #4db8ff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .metric {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #8fa3b0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        #status {
            margin-top: 15px;
            font-size: 0.75rem;
            color: #00e676;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background-color: #00e676;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; box-shadow: 0 0 8px #00e676; }
            50% { opacity: 0.2; box-shadow: none; }
            100% { opacity: 1; box-shadow: 0 0 8px #00e676; }
        }
        
        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: #4db8ff;
            z-index: 20;
        }
    </style>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

    <div id="loading">INITIALIZING TELEMETRY...</div>

    <div id="dashboard" style="display: none;">
        <h1>ISS Telemetry</h1>
        <div class="metric">
            <span class="metric-label">Latitude</span>
            <span class="metric-value" id="lat-val">--</span>
        </div>
        <div class="metric">
            <span class="metric-label">Longitude</span>
            <span class="metric-value" id="lon-val">--</span>
        </div>
        <div class="metric">
            <span class="metric-label">Altitude</span>
            <span class="metric-value" id="alt-val">-- km</span>
        </div>
        <div class="metric">
            <span class="metric-label">Velocity</span>
            <span class="metric-value" id="vel-val">-- km/h</span>
        </div>
        <div id="status">
            <div class="pulse"></div> Live Data Link
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 1. Scene Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 4);

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // Optimize for Bloom
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 1.2;
        controls.maxDistance = 10;

        // --- 2. Bloom Post-Processing ---
        const renderScene = new RenderPass(scene, camera);
        // Resolution, strength, radius, threshold
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 1.0; // Only bloom items with color > 1.0 (our ISS beacon)
        bloomPass.strength = 2.0;
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- 3. Earth Object ---
        const earthRadius = 1;
        const earthGeometry = new THREE.SphereGeometry(earthRadius, 64, 64);
        
        const textureLoader = new THREE.TextureLoader();
        // Using unpkg for reliable, high-res generic textures
        const earthTexture = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg');
        
        const earthMaterial = new THREE.MeshStandardMaterial({
            map: earthTexture,
            roughness: 0.6,
            metalness: 0.1
        });
        
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        // Rotate earth to align texture with standard lat/lng coordinates 
        earth.rotation.y = -Math.PI / 2; 
        scene.add(earth);

        // --- 4. ISS Beacon (Glassmorphic Glowing Sphere) ---
        const issGeometry = new THREE.SphereGeometry(0.015, 16, 16);
        const issMaterial = new THREE.MeshBasicMaterial({ 
            color: new THREE.Color(4.0, 8.0, 10.0) // Values > 1 trigger the BloomPass threshold
        });
        const iss = new THREE.Mesh(issGeometry, issMaterial);
        scene.add(iss);

        // --- 5. Real-Time Solar Ephemeris Math ---
        // Calculates the Sub-Solar point (where the sun is directly overhead) based on current UTC
        function updateSolarLighting() {
            const now = new Date();
            
            // Calculate Day of Year
            const start = new Date(now.getUTCFullYear(), 0, 0);
            const diff = now - start;
            const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));

            // Solar Declination (Latitude of sub-solar point)
            const declination = -23.44 * Math.cos((360 / 365.24) * (dayOfYear + 10) * (Math.PI / 180));

            // Solar Longitude (Moves 15 degrees per hour from Greenwich)
            const utcHours = now.getUTCHours() + now.getUTCMinutes() / 60 + now.getUTCSeconds() / 3600;
            const longitude = (12 - utcHours) * 15;

            // Convert to 3D Vector
            const sunPos = latLongToVector3(declination, longitude, 5); // 5 units away
            
            return sunPos;
        }

        const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
        scene.add(sunLight);
        
        // Faint ambient light so the dark side is dimly visible
        const ambientLight = new THREE.AmbientLight(0x111122, 0.1);
        scene.add(ambientLight);

        // --- 6. Coordinate Math Function ---
        function latLongToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));

            return new THREE.Vector3(x, y, z);
        }

        // --- 7. API Fetch Loop & UI Updates ---
        let targetISSPosition = new THREE.Vector3();
        
        async function fetchISSData() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();

                // Update UI
                document.getElementById('lat-val').innerText = data.latitude.toFixed(4) + '°';
                document.getElementById('lon-val').innerText = data.longitude.toFixed(4) + '°';
                document.getElementById('alt-val').innerText = data.altitude.toFixed(2) + ' km';
                document.getElementById('vel-val').innerText = Math.round(data.velocity).toLocaleString() + ' km/h';

                // Hide Loading, Show Dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                // Calculate exact 3D position 
                // We add a tiny offset to the radius so the beacon hovers just above the surface map
                const altitudeScale = 1.0 + (data.altitude / 6371); // Earth radius is ~6371km
                targetISSPosition = latLongToVector3(data.latitude, data.longitude, altitudeScale);

            } catch (error) {
                console.error("Error fetching ISS Telemetry:", error);
            }
        }

        // Initial fetch and 5-second interval loop
        fetchISSData();
        setInterval(fetchISSData, 5000);

        // --- 8. Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Smoothly interpolate ISS position so it doesn't jump every 5 seconds
            if (targetISSPosition.length() > 0) {
                iss.position.lerp(targetISSPosition, 0.02);
            }

            // Continuously update Sun position based on accurate system time
            const sunPosition = updateSolarLighting();
            sunLight.position.copy(sunPosition);

            // Use the EffectComposer for bloom rendering instead of standard renderer
            composer.render();
        }

        animate();

        // Handle Window Resizing
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
